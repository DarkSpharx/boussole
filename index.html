<div id="boussole" style="text-align:center; margin-top:20px;">
  <div id="cercle" style="
    margin: 0 auto;
    width: 100px;
    height: 100px;
    border: 3px solid red; /* rouge par défaut */
    border-radius: 50%;
    position: relative;
    transition: border-color 0.3s ease;
  ">
    <div id="fleche" style="
      width: 0; 
      height: 0; 
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-bottom: 40px solid red; /* rouge par défaut */
      position: absolute;
      top: 10px;
      left: 35px;
      transform-origin: 50% 90%;
      transition: transform 0.3s ease, border-bottom-color 0.3s ease;
    "></div>
  </div>
  <div id="distance" style="margin-top: 10px; font-weight: bold; font-size: 1.2em;">Calcul en cours...</div>
</div>

<script>
  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;

    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);

    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon/2)**2;

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function getBearing(lat1, lon1, lat2, lon2) {
    const toRad = x => x * Math.PI / 180;
    const toDeg = x => x * 180 / Math.PI;

    const dLon = toRad(lon2 - lon1);
    const y = Math.sin(dLon) * Math.cos(toRad(lat2));
    const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
              Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
    let brng = Math.atan2(y, x);
    brng = toDeg(brng);
    return (brng + 360) % 360;
  }

  function initBoussole(targetLat, targetLon) {
    if (!navigator.geolocation) {
      document.getElementById('distance').textContent = "Géolocalisation non supportée.";
      return;
    }

    navigator.geolocation.watchPosition(pos => {
      const userLat = pos.coords.latitude;
      const userLon = pos.coords.longitude;
      const heading = pos.coords.heading;

      const distance = getDistance(userLat, userLon, targetLat, targetLon);
      const bearing = getBearing(userLat, userLon, targetLat, targetLon);

      let rotation = bearing;
      if (heading !== null) {
        rotation = bearing - heading;
      }
      rotation = (rotation + 360) % 360;

      // Applique la rotation à la flèche
      const fleche = document.getElementById('fleche');
      fleche.style.transform = `rotate(${rotation}deg)`;

      // Change la couleur selon la distance
      const cercle = document.getElementById('cercle');
      if (distance <= 100) {
        cercle.style.borderColor = "green";
        fleche.style.borderBottomColor = "green";
      } else {
        cercle.style.borderColor = "red";
        fleche.style.borderBottomColor = "red";
      }

      // Affiche la distance
      document.getElementById('distance').textContent = Math.round(distance) + " m";

    }, error => {
      document.getElementById('distance').textContent = "Impossible d'obtenir la position.";
    }, {
      enableHighAccuracy: true,
      maximumAge: 1000,
      timeout: 5000
    });
  }

  initBoussole(50.2921, 2.7783);
</script>
