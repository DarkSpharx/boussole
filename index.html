<div id="boussole" style="text-align:center; margin-top:20px;">
  <div style="
    margin: 0 auto;
    width: 100px;
    height: 100px;
    border: 3px solid black;
    border-radius: 50%;
    position: relative;
  ">
    <div id="fleche" style="
      width: 0; 
      height: 0; 
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-bottom: 40px solid red;
      position: absolute;
      top: 10px;
      left: 35px;
      transform-origin: 50% 90%;
      transition: transform 0.3s ease;
    "></div>
  </div>
  <div id="distance" style="margin-top: 10px; font-weight: bold; font-size: 1.2em;">Calcul en cours...</div>
</div>

<script>
  // Fonction pour calculer distance entre deux points GPS en mètres
  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000; // rayon terre en mètres
    const toRad = x => x * Math.PI / 180;

    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);

    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon/2)**2;

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  // Fonction pour calculer l'azimut (angle en degrés du Nord vers la cible)
  function getBearing(lat1, lon1, lat2, lon2) {
    const toRad = x => x * Math.PI / 180;
    const toDeg = x => x * 180 / Math.PI;

    const dLon = toRad(lon2 - lon1);
    const y = Math.sin(dLon) * Math.cos(toRad(lat2));
    const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
              Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
    let brng = Math.atan2(y, x);
    brng = toDeg(brng);
    return (brng + 360) % 360; // angle entre 0 et 360
  }

  // Fonction pour obtenir l'orientation du joueur (l'azimut vers le Nord de son appareil)
  // et faire pivoter la flèche
  function initBoussole(targetLat, targetLon) {
    if (!navigator.geolocation) {
      document.getElementById('distance').textContent = "Géolocalisation non supportée.";
      return;
    }

    navigator.geolocation.watchPosition(pos => {
      const userLat = pos.coords.latitude;
      const userLon = pos.coords.longitude;
      const heading = pos.coords.heading; // direction de l'appareil en degrés par rapport au nord (peut être null)

      const distance = getDistance(userLat, userLon, targetLat, targetLon);
      const bearing = getBearing(userLat, userLon, targetLat, targetLon);

      // Si heading est null, on affiche la flèche orientée vers la cible fixe
      let rotation = bearing;

      // Si on a l'orientation du device, on calcule l'angle relatif à la direction du device
      if (heading !== null) {
        rotation = bearing - heading;
      }

      // On limite la rotation entre 0 et 360 degrés
      rotation = (rotation + 360) % 360;

      // Applique la rotation à la flèche
      document.getElementById('fleche').style.transform = `rotate(${rotation}deg)`;

      // Affiche la distance arrondie en mètres
      document.getElementById('distance').textContent = Math.round(distance) + " m";

    }, error => {
      document.getElementById('distance').textContent = "Impossible d'obtenir la position.";
    }, {
      enableHighAccuracy: true,
      maximumAge: 1000,
      timeout: 5000
    });
  }

  // Appelle la fonction avec les coordonnées cibles (à remplacer par celles de l'acte)
  initBoussole( /* LATITUDE_CIBLE */, /* LONGITUDE_CIBLE */ );
</script>
