<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">

<style>
  #boussole {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 20px;
  }

  #cercle {
    width: 200px;
    height: 200px;
    border: 5px solid red; /* Plus épais */
    border-radius: 50%;
    position: relative;
    transition: border-color 0.3s ease;
  }

  #fleche {
    width: 0;
    height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-bottom: 50px solid red; /* flèche un peu plus longue */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -90%) rotate(0deg); /* base centrée */
    transform-origin: 50% 90%; /* rotation autour de la base */
    transition: transform 0.5s ease, border-bottom-color 0.3s ease;
  }

  #distance {
    margin-top: 10px;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    font-size: 20px;
  }

  @media (min-width: 1024px) {
    #cercle {
      width: 250px;
      height: 250px;
    }

    #fleche {
      border-bottom-width: 70px; /* flèche plus longue sur PC */
    }
  }
</style>

<div id="boussole">
  <div id="cercle">
    <div id="fleche"></div>
  </div>
  <div id="distance">Calcul en cours...</div>
</div>

<script>
  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function getBearing(lat1, lon1, lat2, lon2) {
    const toRad = x => x * Math.PI / 180;
    const toDeg = x => x * 180 / Math.PI;
    const dLon = toRad(lon2 - lon1);
    const y = Math.sin(dLon) * Math.cos(toRad(lat2));
    const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
              Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
    let brng = Math.atan2(y, x);
    return (toDeg(brng) + 360) % 360;
  }

  function initBoussole(targetLat, targetLon) {
    if (!navigator.geolocation) {
      document.getElementById('distance').textContent = "Géolocalisation non supportée.";
      return;
    }

    navigator.geolocation.watchPosition(pos => {
      const userLat = pos.coords.latitude;
      const userLon = pos.coords.longitude;
      const heading = pos.coords.heading;

      const distance = getDistance(userLat, userLon, targetLat, targetLon);
      const bearing = getBearing(userLat, userLon, targetLat, targetLon);
      let rotation = heading !== null ? (bearing - heading + 360) % 360 : bearing;

      const cercle = document.getElementById('cercle');
      const fleche = document.getElementById('fleche');

      fleche.style.transform = `translate(-50%, -90%) rotate(${rotation}deg)`;
      document.getElementById('distance').textContent = Math.round(distance) + " m";

      const couleur = distance <= 100 ? 'green' : 'red';
      cercle.style.borderColor = couleur;
      fleche.style.borderBottomColor = couleur;

    }, error => {
      document.getElementById('distance').textContent = "Position non disponible.";
    }, {
      enableHighAccuracy: true,
      maximumAge: 1000,
      timeout: 5000
    });
  }

  // Coordonnées précises de l'Abbaye Saint-Vaast
  initBoussole(50.291685081054425, 2.773281774184819);
</script>
