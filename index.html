<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boussole simple</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background: #f9f9f9;
    }

    #compass {
      width: 250px;
      height: 250px;
      border-radius: 50%;
      background: red; /* Devient vert si < 50m */
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .arrow {
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-bottom: 70px solid #007bff; /* Couleur flÃ¨che */
      position: absolute;
      bottom: 50%;
      left: 50%;
      transform: translateX(-50%) rotate(0deg);
      transform-origin: 50% 100%; /* Base centrÃ©e au milieu du cercle */
    }

    #distance {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
    }

    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div id="compass">
    <div class="arrow" id="arrow"></div>
  </div>
  <div id="distance">Chargementâ€¦</div>
  <button onclick="location.reload()">ðŸ”„ Actualiser</button>

  <script>
    const target = { lat: 50.29165790413158, lon: 2.773255936643764 };
    let userLat, userLon, heading;

    // Haversine pour calculer la distance
    function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const Ï†1 = lat1 * Math.PI / 180;
      const Ï†2 = lat2 * Math.PI / 180;
      const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
      const Î”Î» = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(Î”Ï† / 2) ** 2 +
                Math.cos(Ï†1) * Math.cos(Ï†2) *
                Math.sin(Î”Î» / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Calcul du cap vers la cible
    function getBearing(lat1, lon1, lat2, lon2) {
      const Ï†1 = lat1 * Math.PI / 180;
      const Ï†2 = lat2 * Math.PI / 180;
      const Î”Î» = (lon2 - lon1) * Math.PI / 180;
      const y = Math.sin(Î”Î») * Math.cos(Ï†2);
      const x = Math.cos(Ï†1) * Math.sin(Ï†2) -
                Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î”Î»);
      return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
    }

    // Mise Ã  jour flÃ¨che et distance
    function updateCompass() {
      if (userLat !== undefined && heading !== undefined) {
        const bearing = getBearing(userLat, userLon, target.lat, target.lon);
        const angle = bearing - heading;
        document.getElementById("arrow").style.transform =
          `translateX(-50%) rotate(${angle}deg)`;

        const dist = getDistanceFromLatLonInM(userLat, userLon, target.lat, target.lon);
        document.getElementById("distance").textContent =
          `Distance : ${Math.round(dist)} m`;

        document.getElementById("compass").style.background =
          dist < 50 ? "green" : "red";
      }
    }

    // RÃ©cupÃ©ration position GPS
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        updateCompass();
      }, err => {
        document.getElementById("distance").textContent = "Erreur GPS";
      }, { enableHighAccuracy: true });
    }

    // Gestion orientation (iOS et Android)
    function setupOrientation() {
      if (typeof DeviceOrientationEvent !== "undefined" &&
          typeof DeviceOrientationEvent.requestPermission === "function") {
        // iOS
        DeviceOrientationEvent.requestPermission().then(response => {
          if (response === "granted") {
            window.addEventListener("deviceorientationabsolute", e => {
              heading = e.alpha;
              updateCompass();
            });
          }
        }).catch(console.error);
      } else {
        // Android
        window.addEventListener("deviceorientationabsolute", e => {
          heading = e.alpha;
          updateCompass();
        });
      }
    }

    window.onload = setupOrientation;
  </script>
</body>
</html>
